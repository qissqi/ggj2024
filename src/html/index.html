<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="../css/styles.css">
  <script src="../js/vue2.js"></script>
</head>

<body>
  <div id="main">
    <div id="top-section">

      <!-- è§’è‰²å›¾ç‰‡ -->
      <div id="top-left-section">
        <img id="character_portrait" :src="gm.portrait">
      </div>

      <div id="top-right-section">
        <!-- è¾“å‡ºé¢æ¿ -->
        <div id="top-right-top-section">
          <textarea id="output-text-area" readonly v-model="output.text_list.join('\n')"></textarea>
        </div>

        <div id="top-right-bottom-section">
          <div id="top-right-bottom-left-section">
            <!-- å±æ€§é¢æ¿ -->
            <table class="status-table">
              <tr>
                <td class="status-emoji"><span>ğŸ“</span></td>
                <td class="status-name"><span>çŸ¥è¯†</span></td>
                <td class="status-value"><span>{{ gm.player.knowledge }} / {{ gm.player.maxKnowledge }}</span></td>
                <td class="status-bar" colspan="3">
                  <div class="progress-bar" :style=progress_bar_style(gm.player.knowledge,gm.player.maxKnowledge)><br></div>
                </td>
              </tr>
              <tr>
                <td class="status-emoji"><span>ğŸ˜†</span></td>
                <td class="status-name"><span>å¿ƒæƒ…</span></td>
                <td class="status-value"><span>{{ gm.player.mood }} / {{ gm.player.maxMood }}</span></td>
                <td class="status-bar" colspan="3">
                  <div class="progress-bar" :style=progress_bar_style(gm.player.mood,gm.player.maxMood)><br></div>
                </td>
              </tr>
              <tr>
                <td class="status-emoji"><span>ğŸ’ª</span></td>
                <td class="status-name"><span>ä½“åŠ›</span></td>
                <td class="status-value"><span>{{ gm.player.energy }} / {{ gm.player.maxEnergy }}</span></td>
                <td class="status-bar" colspan="3">
                  <div class="progress-bar" :style=progress_bar_style(gm.player.energy,gm.player.maxEnergy)><br></div>
                </td>
              </tr>
              <tr>
                <td class="status-emoji"><span>ğŸ’°</span></td>
                <td class="status-name"><span>èµ„äº§</span></td>
                <td class="status-value" colspan="4"><span>{{ gm.player.money }} </span></td>
              </tr>
            </table>
            <table class="status-table">
              <tr>
                <td class="status-emoji"><span>ğŸ²</span></td>
                <td class="status-name"><span>è¡ŒåŠ¨</span></td>
                <td class="status-value"><span>{{ gm.player.actionPoint }} / {{ gm.player.maxActionPoint }}</span></td>
                <td class="status-emoji"><span>ğŸ—“ï¸</span></td>
                <td class="status-name"><span>å¤©æ•°</span></td>
                <td class="status-value"><span>{{ gm.days }}</span></td>
                <td class="empty"><br></td>
              </tr>
            </table>
          </div>

          <!-- é€‰é¡¹é¢æ¿ -->
          <div id="top-right-bottom-right-section">
            <div id="options-panel">
              
              <span>é€‰æ­Œ</span>
              <select @change="select_music()" v-model="gm.music_selected" style="width: 70%;">
                <option v-for="music in gm.music_list" :value="music"> {{ music.name }} </option>
              </select>

              <hr>
              <span>è®¾ç½®å­—ä½“å¤§å°</span>
              <select @change="set_font_size()" v-model="font_size">
                <option v-for="sz in 8" :value="((sz * 2) + 8) + 'px'"> {{sz * 2 + 8}} </option>
              </select>

              <hr>
              <button @click="reset()">é‡å¼€</button>

              <hr>
              <button @click="nextDay()" v-if="gm.ending==0">ä»Šå¤©å¾ˆåŠªåŠ›äº†ï¼Œæ˜å¤©å†ç»§ç»­åŠªåŠ›å§</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="bottom-section">
      <!-- å¡ç»„ -->
      <div id="card-group">

        <!-- å¡ -->
        <div v-for="(card, index) in gm.myCards" @click="click_card(index)"
          :class="['card', gm.checkCardAvailable(index) ? 'is-card-usable' : 'is-card-unusable']" >
          <div class="card-face-div">
            <img class="card-img" :src="card.img" draggable="false">
            <div class="card-name"><span>{{ card.name }}</span></div>
            <div class="is-card-corner">
              <span v-if="gm.myCards[index].used">å·²ä½¿ç”¨</span>
              <span v-else-if="!gm.checkCardAvailable(index)">ä¸å¯ç”¨</span>
            </div>
          </div>

          <table v-if="card.isRandom"
            class="card-effect-table" >
            <tr>
              <td class="card-effect">
                <span>ğŸ“ +?</span>
                <div class="card-effect-bkgd-none"><br></div>
              </td>
              <td class="card-effect">
                <span>ğŸ˜† +?</span>
                <div class="card-effect-bkgd-none"><br></div>
              </td>
            </tr>
            <tr>
              <td class="card-effect">
                <span>ğŸ’ª +?</span>
                <div class="card-effect-bkgd-none"><br></div>
              </td>
              <td class="card-effect">
                <span>ğŸ’° +?</span>
                <div class="card-effect-bkgd-none"><br></div>
              </td>
            </tr>
          </table>
          <table v-else class="card-effect-table">
            <tr>
              <td class="card-effect">
                <span>ğŸ“ {{ num_to_str_with_sign(card.rknowledge) }}</span>
                <div :class="card_effect_style(card.rknowledge)"><br></div>
              </td>
              <td class="card-effect">
                <span>ğŸ˜† {{ num_to_str_with_sign(card.rmood) }}</span>
                <div :class="card_effect_style(card.rmood)"><br></div>
              </td>
            </tr>
            <tr>
              <td class="card-effect">
                <span>ğŸ’ª {{ num_to_str_with_sign(card.renergy) }}</span>
                <div :class="card_effect_style(card.renergy)"><br></div>
              </td>
              <td class="card-effect">
                <span>ğŸ’° {{ num_to_str_with_sign(card.rmoney) }}</span>
                <div :class="card_effect_style(card.rmoney)"><br></div>
              </td>
            </tr>
          </table>
          <hr>
          <p class="card-description">{{ card.desc }}</p>
        </div>
      </div>
    </div>
  </div>
</body>

<script src="../js/zhishixuebao.js"></script>
<script>
  new Vue({
    el: "#main",
    data() {
      return {
        isEnd:false,
        character_portrait: {
          url: "../static/img/ç›´æ’­1.png"
        },
        output: {
          text_area: null,
          text_list_max_length: 100,
          text_list: [
            "ç›®æ ‡ï¼š",
            "ç”¨æœ€å°‘çš„å¤©æ•°, è®©â€œçŸ¥è¯†â€è¿›åº¦æ¡è¾¾åˆ°100%",
            "ç©æ³•ï¼š",
            "1. æ¯å¤©è·å¾— 6 å¼ å¡ç‰Œ, æœ€å·¦ä¾§å›ºå®šä¸º 1 å¼ â€œå­¦çŸ¥è¯†â€ä¸”ä¸å¯è¢«é€‰æ‹©ä¿ç•™",
            "2. æ¯å¤©æ¢å¤è‡³ 4 ä¸ªè¡ŒåŠ¨ç‚¹",
            "3. ç‚¹å‡»å¡ç‰Œæ¶ˆè€—1ä¸ªè¡ŒåŠ¨ç‚¹å¹¶ä½¿ç”¨è¯¥å¡ç‰Œ",
            "4. æ¯å¤©ç»“æŸåï¼Œå¯ä»¥åœ¨å‰©ä½™çš„éšæœºå¡ç‰Œä¸­é€‰æ‹© 1 å¼ ä¿ç•™"
          ],
        },
        font_size: '16px',
        music_list: [
          { name: 'ä¿æŒé™éŸ³', call_back: () => { this.print("å›è°ƒ1"); } },
          { name: 'æ— ' },
        ],
        selected_music: {},

        status: {
          knowledge: { val: 0,  max: 100 },
          mood:      { val: 12, max: 20  },
          energy:    { val: 0,  max: 20  },
          money:     { val: 1000, max: 100 },
          action:    { val: 4,  max: 4   },
          day: 1
        },
        action_count: 1,

        CARD_USAGE_STATUS: {
          usable   : 0,
          unusable : 1,
          used     : 2,
          random   : 3,  /* æœªç¿»å¼€çš„éšæœºäº‹ä»¶å¡ç‰Œ */
        },

        card_group: [],
        gm:this.getGM()
        
      };
    },
    
    mounted() {
      document.documentElement.style.setProperty('--font-size', this.font_size);
      this.output.text_area = this.$el.querySelector('#output-text-area');
    },

    methods: {
      /* è®¾ç½®è§’è‰²ç«‹ç»˜ */
      set_character_portrait(img_url) {
        this.character_portrait.url = img_url;
      },

      /* é€‰æ‹©æ’­æ”¾éŸ³ä¹ */
      select_music() {
        this.print("å·²é€‰æ‹©æ’­æ”¾éŸ³ä¹ï¼š" + gm.music_selected.name);
        
        if (gm.music_selected.call_back) {
          gm.music_selected.call_back();
        }
        else{
          gm.music_mute=false
          gm.playAudio(gm.music_selected.url);
        }
      },

      /* è®¾ç½®å­—ä½“å¤§å° */
      set_font_size() {
        document.documentElement.style.setProperty('--font-size', this.font_size);
        this.print("å·²è®¾ç½®å­—ä½“å¤§å°ä¸ºï¼š" + this.font_size);
      },

      /* è¾“å‡ºæ–‡æœ¬ */
      print(text) {
        this.output.text_list.push(text);

        if (this.output.text_list.length > this.output.text_list_max_length) {
          this.output.text_list.shift();
        }

        this.$nextTick(() => {
          this.output.text_area.scrollTop = this.output.text_area.scrollHeight;
        });
      },

      /* è®¡ç®—è¿›åº¦æ¡ */
      calculate_progress(val,max) {
        return Math.min(val / max * 100, 100);
      },

      /* è®¡ç®—è¿›åº¦æ¡çš„é¢œè‰² */
      progress_bar_style(val,max) {
        let width = Math.min(val / max * 100, 100);
        let color = [
          '#ff0000', '#ff2d00', '#ff7900', '#ff9f00', '#ffc600',
          '#ffd900', '#eeee00', '#d9ff00', '#acff00', '#69f700', '#69f700',
        ][Math.floor(width / 10)];
        return {
          'width': `${ width }%`,
          'background-color': color
        };
      },

      /* å¡ç‰Œæ•ˆç›Šçš„ç®­å¤´ */
      card_effect_style(effect) {
        return effect > 0 ? 'card-effect-bkgd-up' :
               effect < 0 ? 'card-effect-bkgd-down' : 'card-effect-bkgd-none'
      },
      
      /* æ•°å­—è½¬å­—ç¬¦ä¸²ï¼Œå¸¦æœ‰ç¬¦å· */
      num_to_str_with_sign(num) {
        return `${(num >= 0) ? '+' : '-'}${Math.abs(num)}`;
      },

      /* ç‚¹å‡»å¡ç‰Œ */
      click_card(index) {
        if(this.gm.checkCardAvailable(index)){
          var text =  this.gm.cardDesc(index)
          if(text!=null){
            this.print("")
            this.print(text)
          }
        }

        gm.useCard(index);
        console.log(gm.ending,this.isEnd)
        if(gm.ending>0 && !this.isEnd){
          this.print("")
          this.print(`ç»“å±€ ${gm.ending}`)
          this.print(gm.end)
          this.print("")
          this.isEnd=true
        }
      },

      getGM(){
        return gm;
        isEnd=false;
      },

      nextDay(){
        if(!gm.endDay()&&gm.endingDay){
          this.print("")
          this.print("ä»å‰©ä½™çš„éšæœºå¡ä¸­é€‰æ‹©ä¸€å¼ ä¿ç•™ï¼Œå†æ¬¡ç‚¹å‡»ä¸‹ä¸€å¤©åˆ™ä¸ä¿ç•™å¡ç‰Œ")
          this.print("")
        }
        
      },

      reset(){
        this.gm.init()
        this.gm.stopPlayAudio()
        this.output.text_list = [
            "ç›®æ ‡ï¼š",
            "ç”¨æœ€å°‘çš„å¤©æ•°, è®©â€œçŸ¥è¯†â€è¿›åº¦æ¡è¾¾åˆ°100%",
            "ç©æ³•ï¼š",
            "1. æ¯å¤©è·å¾— 6 å¼ å¡ç‰Œ, æœ€å·¦ä¾§å›ºå®šä¸º 1 å¼ â€œå­¦çŸ¥è¯†â€ä¸”ä¸å¯è¢«é€‰æ‹©ä¿ç•™",
            "2. æ¯å¤©æ¢å¤è‡³ 4 ä¸ªè¡ŒåŠ¨ç‚¹",
            "3. ç‚¹å‡»å¡ç‰Œæ¶ˆè€—1ä¸ªè¡ŒåŠ¨ç‚¹å¹¶ä½¿ç”¨è¯¥å¡ç‰Œ",
            "4. æ¯å¤©ç»“æŸåï¼Œå¯ä»¥åœ¨å‰©ä½™çš„éšæœºå¡ç‰Œä¸­é€‰æ‹© 1 å¼ ä¿ç•™"
          ]
      }

    }
  });
</script>

</html>