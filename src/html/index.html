<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" type="text/css" href="../css/styles.css">
  <script src="../js/vue2.js"></script>
</head>

<body>
  <div id="main">
    <div id="top-section">

      <!-- è§’è‰²å›¾ç‰‡ -->
      <div id="top-left-section">
        <img id="character_portrait" :src="player.character_portrait.url" draggable="false">
      </div>

      <div id="top-right-section">
        <!-- è¾“å‡ºé¢æ¿ -->
        <div id="top-right-top-section">
          <textarea id="output-text-area" readonly v-model="output.text_list.join('\n')"></textarea>
        </div>

        <div id="top-right-bottom-section">
          <div id="top-right-bottom-left-section">
            <!-- å±æ€§é¢æ¿ -->
            <table class="status-table">
              <tr>
                <td class="status-emoji"><span>ğŸ“</span></td>
                <td class="status-name"><span>çŸ¥è¯†</span></td>
                <td class="status-value-val"><span>{{ player.status.knowledge.val }}</span></td>
                <td class="status-value-add"><span>{{ hover_card_effect.knowledge == 0 ? "" : num_to_str_with_sign(hover_card_effect.knowledge) }}</span></td>
                <td class="status-value-max"><span>/{{ player.status.knowledge.max }}</span></td>
                <td class="status-bar" colspan="3">
                  <div class="progress-bar" :style="progress_bar_style(
                    player.status.knowledge.val + hover_card_effect.knowledge, player.status.knowledge.max)"
                    ><br></div>
                </td>
              </tr>
              <tr>
                <td class="status-emoji"><span>ğŸ˜†</span></td>
                <td class="status-name"><span>å¿ƒæƒ…</span></td>
                <td class="status-value-val"><span>{{ player.status.mood.val }}</span></td>
                <td class="status-value-add"><span :class="player.status.mood.val + hover_card_effect.mood <= 1 ? 'warn' : ''">
                  {{ hover_card_effect.mood == 0 ? "" : num_to_str_with_sign(hover_card_effect.mood) }}</span></td>
                <td class="status-value-max"><span>/{{ player.status.mood.max }}</span></td>
                <td class="status-bar" colspan="3">
                  <div class="progress-bar" :style="progress_bar_style(
                    player.status.mood.val + hover_card_effect.mood, player.status.mood.max)"
                    ><br></div>
                </td>
              </tr>
              <tr>
                <td class="status-emoji"><span>ğŸ’ª</span></td>
                <td class="status-name"><span>ä½“åŠ›</span></td>
                <td class="status-value-val"><span>{{ player.status.energy.val }}</span></td>
                <td class="status-value-add"><span :class="player.status.energy.val + hover_card_effect.energy <= 1 ? 'warn' : ''">
                  {{ hover_card_effect.energy == 0 ? "" : num_to_str_with_sign(hover_card_effect.energy) }}</span></td>
                <td class="status-value-max"><span>/{{ player.status.energy.max }}</span></td>
                <td class="status-bar" colspan="3">
                  <div class="progress-bar" :style="progress_bar_style(
                    player.status.energy.val + hover_card_effect.energy, player.status.energy.max)"
                    ><br></div>
                </td>
              </tr>
              <tr>
                <td class="status-emoji"><span>ğŸ’°</span></td>
                <td class="status-name"><span>èµ„äº§</span></td>
                <td class="status-value-val"><span>{{ player.status.money.val }}</span></td>
                <td class="status-value-add"><span :class="player.status.money.val + hover_card_effect.money <= 3 ? 'warn' : ''">
                  {{ hover_card_effect.money == 0 ? "" : num_to_str_with_sign(hover_card_effect.money) }}</span></td>
                <td class="status-value-max"><span>/{{ player.status.money.max }}</span></td>
                <td class="status-bar" colspan="3">
                  <div class="progress-bar" :style="progress_bar_style(
                    player.status.money.val + hover_card_effect.money, player.status.money.max)"
                    ><br></div>
                </td>
              </tr>
            </table>
            <table class="status-table">
              <tr>
                <td class="status-emoji"><span>ğŸ²</span></td>
                <td class="status-name"><span>è¡ŒåŠ¨</span></td>
                <td class="status-value-val"><span>{{ player.action_count.val }}</span></td>
                <td class="empty"><br></td>
                <td class="status-emoji"><span>ğŸ—“ï¸</span></td>
                <td class="status-name"><span>å¤©æ•°</span></td>
                <td class="status-value-val"><span>{{ player.round_count }}</span></td>
                <td class="empty"><br></td>
              </tr>
            </table>
          </div>

          <!-- é€‰é¡¹é¢æ¿ -->
          <div id="top-right-bottom-right-section">
            <div id="options-panel">
              
              <span>é€‰æ­Œ</span>
              <select @change="select_music()" v-model="player.audioPlayer.music_selected" style="width: 70%;">
                <option v-for="music in player.audioPlayer.music_list" :value="music"> {{ music.name }} </option>
              </select>

              <hr>
              <span style="color: chocolate">è®¾ç½®å­—ä½“å¤§å°</span>
              <select @change="set_font_size()" v-model="font_size">
                <option v-for="sz in 8" :value="((sz * 2) + 8) + 'px'"> {{sz * 2 + 8}} </option>
              </select>

              <hr>
              <button @click="reset()">é‡å¼€</button>
              <hr>
              <button @click="next_round()">æ˜å¤©å†ç»§ç»­åŠªåŠ›å§</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="bottom-section">
      <!-- å¡ç»„ -->
      <div id="card-group">

        <!-- å¡ -->
        <div v-for="(card, idx) in player.card_group" @click="click_card(idx)"
          @mouseenter="hover_card(card)" @mouseleave="hover_card(null)"
          :class="['card',
            card.usage_status & Card_USAGE_STATUS.random ? 'is-random-card' : '',

               (click_card_status.val == click_card_status.enum.use  && (card.usage_status & Card_USAGE_STATUS.usable))
            || (click_card_status.val == click_card_status.enum.keep && !(card.usage_status & Card_USAGE_STATUS.used) && idx != 0)
            ? 'is-card-usable' : 'is-card-unusable']">
          <div class="card-face-div">
            <img class="card-img" :src="card.img_url" draggable="false">
            <div class="card-name"><span>{{ card.name }}</span></div>
            <div class="card-corner">
              <span>
                {{
                  card.usage_status & Card_USAGE_STATUS.used           ? "å·²ä½¿ç”¨" :

                  click_card_status.val == click_card_status.enum.use
                  && !(card.usage_status & Card_USAGE_STATUS.usable)   ? "ä¸å¯ç”¨" :

                  click_card_status.val == click_card_status.enum.keep
                  && idx == 0                                          ? "æ— é¡»ç»§æ‰¿" : ""
                }}
              </span>
            </div>
          </div>
          <table class="card-effect-table">
            <tr>
              <td class="card-effect">
                <span>ğŸ“ {{ num_to_str_with_sign(card.effect.knowledge) }}</span>
                <div :class="card_effect_style(card.effect.knowledge)"><br></div>
              </td>
              <td class="card-effect">
                <span>ğŸ˜† {{ num_to_str_with_sign(card.effect.mood) }}</span>
                <div :class="card_effect_style(card.effect.mood)"><br></div>
              </td>
            </tr>
            <tr>
              <td class="card-effect">
                <span>ğŸ’ª {{ num_to_str_with_sign(card.effect.energy) }}</span>
                <div :class="card_effect_style(card.effect.energy)"><br></div>
              </td>
              <td class="card-effect">
                <span>ğŸ’° {{ num_to_str_with_sign(card.effect.money) }}</span>
                <div :class="card_effect_style(card.effect.money)"><br></div>
              </td>
            </tr>
          </table>
          <hr>
          <p class="card-description">{{ card.description }}</p>
        </div>
      </div>
    </div>
  </div>
</body>

<script src="../js/zhishixuebao.js"></script>
<script>
  new Vue({
    el: "#main",
    data() {
      return {
        character_portrait: {
          url: "../static/img/ç›´æ’­1.png"
        },
        output: {
          text_area: null,
          text_list_max_length: 100,
          text_list: [],
        },
        font_size: '16px',

        player: new Player(),
        Card_USAGE_STATUS: Card.USAGE_STATUS,
        hover_card_effect: {
          knowledge: 0,
          mood     : 0,
          energy   : 0,
          money    : 0,
        },

        click_card_status: {
          enum: { use: 0, keep: 1 },
          val: 0,
        }
      };
    },
    
    mounted() {
      document.documentElement.style.setProperty('--font-size', this.font_size);
      this.output.text_area = this.$el.querySelector('#output-text-area');
      this.reset();
    },

    methods: {
      /* è®¾ç½®è§’è‰²ç«‹ç»˜ */
      set_character_portrait(img_url) {
        this.character_portrait.url = img_url;
      },

      print_intro() {
        this.print(
`--- [ çŸ¥è¯† å­¦çˆ† 100 å¤© ] ---
 * ç©æ³•ï¼š
  1. æ¯å¤©å›ºå®š 1 å¼ å­¦ä¹ å¡ã€ 5 å¼ éšæœºå¡å’Œ 4 ä¸ªè¡ŒåŠ¨ç‚¹
  2. æ¶ˆè€—ä¸€ä¸ªè¡ŒåŠ¨ç‚¹ä½¿ç”¨ä¸€å¼ å¡
  3. è€—å°½è¡ŒåŠ¨ç‚¹åï¼Œç‚¹å‡»â€œæ˜å¤©ç»§ç»­åŠªåŠ›â€ï¼Œå¼€å¯æ–°çš„ä¸€å¤©
     ï¼ˆå¯é€‰ 1 å¼ æœªä½¿ç”¨çš„å¡ç»§æ‰¿åˆ°æ˜å¤©ï¼‰
  4. è‹¥è¡ŒåŠ¨ç‚¹æœªè€—å°½ï¼Œä¹Ÿå¯å¼€å¯æ–°çš„ä¸€å¤©ï¼Œä½†æ˜¯æœ‰å‡ ç‡æ‰£é™¤å°‘è®¸ä½“åŠ›å’Œå¿ƒæƒ…
 * ç»“å±€ï¼š
  1. â€œçŸ¥è¯†â€ æˆ– â€œèµ„äº§â€ è¿›åº¦æ¡è¾¾åˆ°100%ï¼Œåˆ™æ¸¸æˆèƒœåˆ©
  2. ä¸€å¤©ç»“æŸåï¼Œå¦‚æœå¿ƒæƒ…ä½è½ï¼Œæˆ–ä½“åŠ›é€æ”¯ï¼Œæˆ–è€—å°½èµ„äº§ï¼Œåˆ™æ¸¸æˆå¤±è´¥
     ï¼ˆå¿ƒæƒ…=0ï¼Œæˆ–ä½“åŠ›=0ï¼Œæˆ–å¿ƒæƒ…+ä½“åŠ›<=3ï¼Œæˆ–èµ„äº§<=3ï¼‰
  3. 100 å¤©åæœªèƒœåˆ©ï¼Œåˆ™æ¸¸æˆå¤±è´¥
`     );
        this.$nextTick(() => {
          this.output.text_area.scrollTop = 0;
        });
      },

      /* é€‰æ‹©æ’­æ”¾éŸ³ä¹ */
      select_music(music) {
        this.print("æ’­æ”¾éŸ³ä¹");
        this.player.audioPlayer.playSelect(this.player.audioPlayer.music_selected)
      },

      /* è®¾ç½®å­—ä½“å¤§å° */
      set_font_size() {
        document.documentElement.style.setProperty('--font-size', this.font_size);
      },

      /* è¾“å‡ºæ–‡æœ¬ */
      print(text) {
        this.output.text_list.push(text);

        if (this.output.text_list.length > this.output.text_list_max_length) {
          this.output.text_list.shift();
        }

        this.$nextTick(() => {
          this.output.text_area.scrollTop = this.output.text_area.scrollHeight;
        });
      },

      /* è·å–é¼ æ ‡ä¸‹æ–¹çš„å¡ç‰Œçš„ä¿¡æ¯ */
      hover_card(card) {
        if (card == null) {
          this.hover_card_effect.knowledge = 0;
          this.hover_card_effect.mood      = 0;
          this.hover_card_effect.energy    = 0;
          this.hover_card_effect.money     = 0;
          return;
        }

        if ((this.click_card_status.val == this.click_card_status.enum.use  && card.usage_status & this.Card_USAGE_STATUS.usable)
         || (this.click_card_status.val == this.click_card_status.enum.keep && !(card.usage_status & this.Card_USAGE_STATUS.used)))
        {
          this.hover_card_effect.knowledge = card.effect.knowledge;
          this.hover_card_effect.mood      = card.effect.mood     ;
          this.hover_card_effect.energy    = card.effect.energy   ;
          this.hover_card_effect.money     = card.effect.money    ;
        }
      },

      /* è®¡ç®—è¿›åº¦æ¡ */
      calculate_progress(val,max) {
        return Math.min(val / max * 100, 100);
      },

      /* è®¡ç®—è¿›åº¦æ¡çš„é¢œè‰² */
      progress_bar_style(val, max) {
        let width = Math.min(val / max * 100, 100);
        let color = [
          '#ff0000', '#ff2d00', '#ff7900', '#ff9f00', '#ffc600',
          '#ffd900', '#eeee00', '#d9ff00', '#acff00', '#69f700', '#69f700',
        ][Math.floor(width / 10)];
        return {
          'width': `${ width }%`,
          'background-color': color
        };
      },

      /* å¡ç‰Œæ•ˆç›Šçš„ç®­å¤´ */
      card_effect_style(effect) {
        return effect > 0 ? 'card-effect-bkgd-up' :
               effect < 0 ? 'card-effect-bkgd-down' : 'card-effect-bkgd-none'
      },
      
      /* æ•°å­—è½¬å­—ç¬¦ä¸²ï¼Œå¸¦æœ‰ç¬¦å· */
      num_to_str_with_sign(num) {
        return num == null ? "?" : `${(num >= 0) ? '+' : '-'}${Math.abs(num)}`;
      },

      /* ç‚¹å‡»å¡ç‰Œ */
      click_card(idx) {
        /* åˆ¤æ–­æ¸¸æˆç»“æŸ */
        if (this.player.is_game_over()) {
            this.game_over();
            return;
        }
        /* é€‰å¡æ¨¡å¼ï¼Œç»§æ‰¿åˆ°ä¸‹ä¸€å›åˆ */
        if (this.click_card_status.val == this.click_card_status.enum.keep) {
          this.next_round(idx);
          return;
        }
        /* else å‡ºå¡æ¨¡å¼ */
        /* å‡ºå¡ */
        let res = this.player.use_card(idx);
        if (false == res.val) {
          this.print(`æ— æ³•ä½¿ç”¨ [${this.player.card_group[idx].name}] ${res.txt}`);
          return;
        }
        /* å‡ºå¡æˆåŠŸ */
        this.hover_card(null);
        this.print(`[è¡ŒåŠ¨${this.player.action_count.val + 1}]\n` +
                   `ä½¿ç”¨[${this.player.card_group[idx].name}] ${res.txt}`);
        /* åˆ¤æ–­æ¸¸æˆç»“æŸ */
        if (this.player.is_game_over()) {
            this.game_over();
            return;
        }
      },

      /* é‡å¼€ */
      reset() {
        this.output.text_list.length = 0;
        this.click_card_status.val = this.click_card_status.enum.use;
        this.player.reset();
        this.print_intro();
      },

      /* ä¸‹ä¸€å›åˆ */
      next_round(keep_card_idx=null) {
        /* ä»ç”¨å¡æ¨¡å¼å˜æˆç•™å¡æ¨¡å¼ */
        if (this.click_card_status.val == this.click_card_status.enum.use) {
          /* åˆ¤æ–­æ¸¸æˆç»“æŸ */
          if (true == this.player.judge_game_over_before_next()) {
            this.game_over();
            return;
          }

          /* å˜æˆç•™å¡æ¨¡å¼ */
          this.click_card_status.val = this.click_card_status.enum.keep;
          this.print("æ˜å¤©å†ç»§ç»­åŠªåŠ›å§ï¼Œé€‰æ‹©ä¸€å¼ æœªä½¿ç”¨è¿‡çš„å¡ä»¥ç»§æ‰¿åˆ°æ˜å¤©ï¼ˆå†æ¬¡ç‚¹å‡»åˆ™ä¸ç»§æ‰¿å¡ï¼‰");
        }
        /* è¿›å…¥ä¸‹ä¸€å›åˆ */
        else /* this.click_card_status.val == this.click_card_status.enum.keep */
        {
          /* è¿™é‡Œä¸éœ€è¦åˆ¤æ–­æ¸¸æˆç»“æŸï¼Œå› ä¸ºç•™å¡æ¨¡å¼çš„æ—¶å€™å·²ç»åˆ¤æ–­è¿‡äº† */
          let res = this.player.next_round(keep_card_idx);
          if (false == res.val) {
            this.print(res.txt);
            return;
          }
          
          this.click_card_status.val = this.click_card_status.enum.use;
          this.print(`[ç¬¬${this.player.round_count}å¤©]\n` + res.txt)
        }
      },

      /* æ‰“å°æ¸¸æˆç»“å±€ */
      game_over() {
        this.print(this.player.game_outcome.text);
      }
    }
  });
</script>

</html>